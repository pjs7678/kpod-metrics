apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
data:
  application.yml: |
    kpod:
      profile: {{ .Values.config.profile }}
      poll-interval: {{ .Values.config.pollInterval }}
      collection-timeout: {{ .Values.config.collectionTimeout | default 20000 }}
      node-name: ${NODE_NAME}
      {{- if .Values.config.clusterName }}
      cluster-name: {{ .Values.config.clusterName }}
      {{- end }}
      {{- if .Values.config.collectors }}
      collectors:
        {{- toYaml .Values.config.collectors | nindent 8 }}
      {{- end }}
      discovery:
        mode: ${KPOD_DISCOVERY_MODE:informer}
        kubelet-poll-interval: {{ .Values.config.discovery.kubeletPollInterval }}
        node-ip: ${NODE_IP:}
      bpf:
        program-dir: /app/bpf
      cgroup:
        root: {{ .Values.config.cgroup.root }}
        proc-root: {{ .Values.config.cgroup.procRoot }}
      filter:
        {{- if .Values.config.filter.namespaces }}
        namespaces:
          {{- toYaml .Values.config.filter.namespaces | nindent 10 }}
        {{- else }}
        namespaces: []
        {{- end }}
        exclude-namespaces:
          {{- toYaml .Values.config.filter.excludeNamespaces | nindent 10 }}
        {{- if .Values.config.filter.labelSelector }}
        label-selector: {{ .Values.config.filter.labelSelector | quote }}
        {{- end }}
        include-labels:
          {{- toYaml .Values.config.filter.includeLabels | nindent 10 }}
    spring:
      threads:
        virtual:
          enabled: true
    server:
      port: 9090
      shutdown: graceful
    spring.lifecycle:
      timeout-per-shutdown-phase: 30s
    management:
      endpoints:
        web:
          exposure:
            include: health, prometheus, info, kpodDiagnostics
      metrics:
        export:
          prometheus:
            enabled: true
